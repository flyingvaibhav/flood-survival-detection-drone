{% extends "layout.html" %}

{% block content %}
<div class="grid grid-cols-12 gap-4 p-4 w-full h-full">
    
    <!-- Left Column: Video & Controls -->
    <div class="col-span-4 flex flex-col gap-4">
        <!-- Video Feed -->
        <div class="glass-panel rounded-lg p-1 flex-1 relative overflow-hidden flex flex-col group">
            <div class="absolute top-2 left-2 bg-black/50 px-2 py-1 rounded text-xs font-mono text-red-400 flex items-center gap-2 z-10">
                <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div> LIVE FEED - SCOUT 01
            </div>
            
            <!-- HUD Overlay -->
            <div class="absolute inset-0 pointer-events-none z-20 p-4 flex flex-col justify-between opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <div class="flex justify-between items-start">
                    <div class="font-mono text-xs text-green-400 bg-black/50 p-1 rounded">
                        CAM: EO/IR<br>
                        ZOOM: 1.0x
                    </div>
                    <div class="font-mono text-xs text-green-400 bg-black/50 p-1 rounded text-right">
                        REC: ON<br>
                        STRG: 64GB
                    </div>
                </div>
                <div class="flex justify-center items-center">
                    <div class="w-8 h-8 border border-green-400/50 rounded-full flex items-center justify-center">
                        <div class="w-1 h-1 bg-green-400 rounded-full"></div>
                    </div>
                </div>
                <div class="flex justify-between items-end">
                    <div class="font-mono text-xs text-green-400 bg-black/50 p-1 rounded">
                        LAT: <span id="hud-lat">28.6139</span><br>
                        LON: <span id="hud-lon">77.2090</span>
                    </div>
                    <div class="font-mono text-xs text-green-400 bg-black/50 p-1 rounded text-right">
                        ALT: <span id="hud-alt">10</span>m<br>
                        SPD: <span id="hud-spd">5</span>m/s
                    </div>
                </div>
            </div>

            <img src="/api/video_feed" class="w-full h-full object-cover bg-black rounded" alt="Video Feed Unavailable">
        </div>

        <!-- Mission Controls -->
        <div class="glass-panel rounded-lg p-4 h-1/3">
            <h2 class="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wider">Mission Commands</h2>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="startScan()" class="bg-blue-600 hover:bg-blue-500 text-white py-3 px-4 rounded font-bold flex items-center justify-center gap-2 transition">
                    <i data-lucide="scan-line"></i> START SCAN
                </button>
                <button onclick="stopScan()" class="bg-slate-700 hover:bg-slate-600 text-white py-3 px-4 rounded font-bold flex items-center justify-center gap-2 transition">
                    <i data-lucide="octagon-pause"></i> STOP
                </button>
                <button onclick="deployDelivery()" class="bg-emerald-600 hover:bg-emerald-500 text-white py-3 px-4 rounded font-bold flex items-center justify-center gap-2 col-span-2 transition">
                    <i data-lucide="package-check"></i> DEPLOY DELIVERY DRONE
                </button>
                <button class="bg-amber-600 hover:bg-amber-500 text-white py-2 px-4 rounded font-bold flex items-center justify-center gap-2 col-span-2 transition text-sm">
                    <i data-lucide="megaphone"></i> BROADCAST MESSAGE
                </button>
            </div>
        </div>
    </div>

    <!-- Middle Column: Map -->
    <div class="col-span-5 glass-panel rounded-lg p-1 relative">
        <div id="map" class="w-full h-full rounded bg-slate-800"></div>
        <div class="absolute bottom-4 left-4 bg-slate-900/90 p-3 rounded border border-slate-700 text-xs font-mono">
            <div class="mb-1 text-slate-400">MAP OVERLAY</div>
            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span> SCOUT DRONE</div>
            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-500"></span> DELIVERY DRONE</div>
            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span> SURVIVOR</div>
        </div>
    </div>

    <!-- Right Column: Telemetry & Status -->
    <div class="col-span-3 flex flex-col gap-4">
        <!-- Scout Status -->
        <div class="glass-panel rounded-lg p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-blue-400">SCOUT DRONE</h3>
                <span id="scout-mode" class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded">IDLE</span>
            </div>
            <div class="space-y-3 font-mono text-sm">
                <div class="flex justify-between"><span>BATTERY</span> <span id="scout-bat" class="text-green-400">100%</span></div>
                <div class="flex justify-between"><span>ALTITUDE</span> <span id="scout-alt">0m</span></div>
                <div class="flex justify-between"><span>SPEED</span> <span id="scout-spd">0m/s</span></div>
                <div class="border-t border-slate-700 pt-2 mt-2">
                    <div class="text-xs text-slate-500">CURRENT TASK</div>
                    <div id="scout-task" class="text-white truncate">Ready</div>
                </div>
            </div>
        </div>

        <!-- Delivery Status -->
        <div class="glass-panel rounded-lg p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-emerald-400">DELIVERY DRONE</h3>
                <span id="delivery-mode" class="text-xs bg-emerald-900 text-emerald-200 px-2 py-1 rounded">IDLE</span>
            </div>
            <div class="space-y-3 font-mono text-sm">
                <div class="flex justify-between"><span>BATTERY</span> <span id="delivery-bat" class="text-green-400">100%</span></div>
                <div class="flex justify-between"><span>PAYLOAD</span> <span class="text-white">1/1</span></div>
                <div class="border-t border-slate-700 pt-2 mt-2">
                    <div class="text-xs text-slate-500">CURRENT TASK</div>
                    <div id="delivery-task" class="text-white truncate">Ready</div>
                </div>
            </div>
        </div>

        <!-- Survivors List -->
        <div class="glass-panel rounded-lg p-4 flex-1 overflow-hidden flex flex-col">
            <h3 class="font-bold text-red-400 mb-2 flex justify-between">
                SURVIVORS DETECTED
                <span id="survivor-count" class="bg-red-900 text-red-200 px-2 rounded text-xs flex items-center">0</span>
            </h3>
            <div id="survivor-list" class="overflow-y-auto flex-1 space-y-2 pr-1">
                <!-- Items injected via JS -->
                <div class="text-center text-slate-600 text-sm mt-10">No survivors detected yet.</div>
            </div>
        </div>
        
        <!-- Mission Logs -->
        <div class="glass-panel rounded-lg p-4 h-48 overflow-hidden flex flex-col">
            <h3 class="font-bold text-slate-400 mb-2 text-xs uppercase">Mission Logs</h3>
            <div id="mission-logs" class="overflow-y-auto flex-1 font-mono text-xs space-y-1 text-slate-300">
                <!-- Logs injected via JS -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Map Init
    const map = L.map('map').setView([28.6139, 77.2090], 18);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);
    
    // Add Sector A Polygon (Mock 30 hectares area)
    const sectorA = L.polygon([
        [28.6150, 77.2080],
        [28.6150, 77.2100],
        [28.6130, 77.2100],
        [28.6130, 77.2080]
    ], {
        color: 'blue',
        fillColor: '#3b82f6',
        fillOpacity: 0.1,
        weight: 1,
        dashArray: '5, 5'
    }).addTo(map);
    sectorA.bindPopup("Sector A - Search Area");

    // Drone Trails
    const scoutTrail = L.polyline([], {color: 'blue', weight: 2, opacity: 0.5}).addTo(map);
    const deliveryTrail = L.polyline([], {color: 'emerald', weight: 2, opacity: 0.5}).addTo(map);

    // Icons
    const scoutIcon = L.divIcon({className: 'bg-blue-500 w-4 h-4 rounded-full border-2 border-white shadow-lg'});
    const deliveryIcon = L.divIcon({className: 'bg-emerald-500 w-4 h-4 rounded-full border-2 border-white shadow-lg'});
    const survivorIcon = L.divIcon({className: 'bg-red-500 w-3 h-3 rounded-full animate-pulse'});

    let scoutMarker = L.marker([28.6139, 77.2090], {icon: scoutIcon}).addTo(map);
    let deliveryMarker = L.marker([28.6139, 77.2090], {icon: deliveryIcon}).addTo(map);
    let survivorMarkers = {};

    // API Calls
    async function startScan() {
        await fetch('/api/mission/start_scan', {method: 'POST'});
    }

    async function stopScan() {
        await fetch('/api/mission/stop_scan', {method: 'POST'});
    }

    async function deployDelivery() {
        await fetch('/api/mission/deploy_delivery', {method: 'POST'});
    }

    // Polling for updates
    setInterval(async () => {
        try {
            const res = await fetch('/api/status');
            const data = await res.json();
            updateDashboard(data);
            
            // Fetch logs separately
            const logRes = await fetch('/api/logs');
            const logs = await logRes.json();
            updateLogs(logs);
        } catch (e) {
            console.error("Status fetch failed", e);
        }
    }, 1000);

    function updateDashboard(data) {
        // Update Scout
        document.getElementById('scout-mode').innerText = data.scout.mode;
        document.getElementById('scout-bat').innerText = data.scout.battery.toFixed(1) + '%';
        document.getElementById('scout-task').innerText = data.scout.current_task;
        scoutMarker.setLatLng([data.scout.lat, data.scout.lon]);
        scoutTrail.addLatLng([data.scout.lat, data.scout.lon]);
        
        // Update HUD
        document.getElementById('hud-lat').innerText = data.scout.lat.toFixed(4);
        document.getElementById('hud-lon').innerText = data.scout.lon.toFixed(4);
        document.getElementById('hud-alt').innerText = data.scout.altitude.toFixed(1);
        document.getElementById('hud-spd').innerText = data.scout.speed.toFixed(1);

        // Update Delivery
        document.getElementById('delivery-mode').innerText = data.delivery.mode;
        document.getElementById('delivery-bat').innerText = data.delivery.battery.toFixed(1) + '%';
        document.getElementById('delivery-task').innerText = data.delivery.current_task;
        deliveryMarker.setLatLng([data.delivery.lat, data.delivery.lon]);
        deliveryTrail.addLatLng([data.delivery.lat, data.delivery.lon]);

        // Update Survivors
        document.getElementById('survivor-count').innerText = data.survivors.length;
        const list = document.getElementById('survivor-list');
        
        if (data.survivors.length === 0) {
            list.innerHTML = '<div class="text-center text-slate-600 text-sm mt-10">No survivors detected yet.</div>';
        } else {
            // Simple diffing could be better, but full rebuild is fine for small N
            list.innerHTML = ''; 
            data.survivors.forEach(s => {
                // Add marker if new
                if (!survivorMarkers[s.id]) {
                    survivorMarkers[s.id] = L.marker([s.lat, s.lon], {icon: survivorIcon}).addTo(map)
                        .bindPopup(`Survivor #${s.id} <br> Conf: ${(s.confidence*100).toFixed(0)}%`);
                }

                // Add list item
                const item = document.createElement('div');
                item.className = 'bg-slate-800/50 p-2 rounded border-l-2 border-red-500 text-xs flex gap-2';
                
                let imgHtml = '';
                if (s.image_path) {
                    imgHtml = `<img src="${s.image_path}" class="w-12 h-12 object-cover rounded border border-slate-600" onclick="window.open('${s.image_path}', '_blank')">`;
                } else {
                    imgHtml = `<div class="w-12 h-12 bg-slate-700 rounded flex items-center justify-center text-slate-500"><i data-lucide="user"></i></div>`;
                }

                item.innerHTML = `
                    ${imgHtml}
                    <div class="flex-1">
                        <div class="flex justify-between font-bold text-slate-300">
                            <span>ID: #${s.id}</span>
                            <span>${(s.confidence*100).toFixed(0)}%</span>
                        </div>
                        <div class="text-slate-500 font-mono mt-1">${s.lat.toFixed(5)}, ${s.lon.toFixed(5)}</div>
                        <div class="text-right text-emerald-400 mt-1">${s.status}</div>
                    </div>
                `;
                list.appendChild(item);
                lucide.createIcons(); // Refresh icons
            });
        }
    }
    
    function updateLogs(logs) {
        const container = document.getElementById('mission-logs');
        container.innerHTML = logs.map(log => `
            <div class="flex gap-2">
                <span class="text-slate-500">[${new Date(log.timestamp).toLocaleTimeString()}]</span>
                <span class="${log.level === 'ERROR' ? 'text-red-400' : (log.level === 'SUCCESS' ? 'text-green-400' : 'text-blue-300')}">${log.message}</span>
            </div>
        `).join('');
    }
</script>
{% endblock %}
